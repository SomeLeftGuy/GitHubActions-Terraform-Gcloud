name: Docker Image CI

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

jobs:
 configure_gcloud:

    runs-on: ubuntu-latest
  
    steps:
    - id: 'auth'
      uses: 'google-github-actions/auth@v1'
      with:
        credentials_json: '${{secrets.GOOGLE_AUTH}}'
        
    - name: 'Set up Cloud SDK'
      uses: 'google-github-actions/setup-gcloud@v1'
      
    - name: 'Authenticate Docker and Gcloud'
      run: gcloud auth print-access-token | docker login -u oauth2accesstoken --password-stdin https://europe-central2-docker.pkg.dev

 # build_and_push_image:
 #  runs-on: ubuntu-latest
 #  needs: configure_gcloud
 #  steps:
    - uses: actions/checkout@v3
  
    - name: Build the web-counter image
      run: docker build . --file HelloWorld/Dockerfile --tag europe-central2-docker.pkg.dev/artful-patrol-313709/testrepo/web-counter:latest
   
    - name: Push the web-counter image
      run: docker push europe-central2-docker.pkg.dev/artful-patrol-313709/testrepo/web-counter:latest



      
    - name: build the balancer image
      run: docker build . --file balancerapp/Dockerfile --tage europe-central2-docker.pkg.dev/artful-patrol-313709/testrepo/balancer:latest
  
    - name: Push the balancer image
      run: docker push europe-central2-docker.pkg.dev/artful-patrol-313709/testrepo/balancer:latest



      
    - uses: hashicorp/setup-terraform@v2
    # - name: copy file from bucket
    #   run: gcloud storage cp gs://artful-patrol-313709-terraform-bucket/main.tf main.tf
    - name: the fuck u think is that?
      run: terraform init
    - name: Applying changes
      run: terraform apply --auto-approve -var AUTH_TOKEN=$(gcloud auth print-access-token)
     
  
 
